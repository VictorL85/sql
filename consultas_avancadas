use restaurante;

create view resumo_pedido as
select pe.id_pedido, pe.quantidade, pe.data_pedido, c.nome as cliente, c.email, f.nome as funcionario, pr.nome as produto, pr.preco
from pedidos pe inner join clientes c on pe.id_cliente = c.id_cliente
inner join produtos pr on  pe.id_produto = pr.id_produto
inner join funcionarios f on pe.id_funcionario = f.id_funcionario;

--Selecione o id do pedido, nome do cliente e o total (quantidade * preco) de cada pedido da view resumo_pedido
select id_pedido, cliente, (preco*quantidade) as total from resumo_pedido;

--Atualiza o view resumo pedido, adicionando campo total
create or replace view resumo_pedido as
select pe.id_pedido, pe.quantidade, pe.data_pedido, c.nome as cliente, c.email, f.nome as funcionario, pr.nome as produto, pr.preco,  (pr.preco*pe.quantidade) as total
from pedidos pe inner join clientes c on pe.id_cliente = c.id_cliente
inner join produtos pr on  pe.id_produto = pr.id_produto
inner join funcionarios f on pe.id_funcionario = f.id_funcionario;

select id_pedido, cliente, total from resumo_pedido;

explain
select id_pedido, cliente, total from resumo_pedido;

--Crie uma função chamada ‘BuscaIngredientesProduto’, que irá retornar os ingredientes da tabela info produtos, quando passar o id de produto como argumento (entrada) da função.
DELIMITER //
create function BuscaIngredientesProduto(idpro int)
returns text
reads sql data
begin
declare ingre text;
select i.ingredientes into ingre from info_produtos i 
inner join produtos pr on i.id_produto = pr.id_produto
where pr.id_produto = idpro;
return ingre;
end //
DELIMITER ;

--Execute a função ‘BuscaIngredientesProduto’ com o id de produto 10
select BuscaIngredientesProduto(10);

--Crie uma função chamada ‘mediaPedido’ que irá retornar uma mensagem dizendo que o total do pedido é acima, abaixo ou igual a média de todos os pedidos, quando passar o id do pedido como argumento da função
DELIMITER //
create function mediaPedido(idped int)
returns varchar(50)
reads sql data
begin
declare medipre decimal (10,2);
declare totalpre decimal (10,2);
declare mediped varchar(50);
select avg(preco) into medipre from produtos;
select (pr.preco*pe.quantidade)  into totalpre from pedidos pe
inner join produtos pr on  pe.id_produto = pr.id_produto
where  idped = pe.id_pedido;
set mediped = case
when totalpre > medipre then 'Acima da media'
when totalpre < medipre then 'Abaixo da media'
else 'Na media'
end;
return mediped;
end// 
DELIMITER ;

--Execute a função ‘mediaPedido’ com o id de pedido 5 e depois 6.
select mediaPedido(5);
select mediaPedido(6);
